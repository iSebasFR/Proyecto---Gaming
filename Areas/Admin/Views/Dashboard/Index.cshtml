@model Proyecto_Gaming.Areas.Admin.Controllers.AdminDashboardVm
@{
    ViewData["Title"] = "Panel de Administraci√≥n";

    // C√°lculos derivados que NO requieren cambiar tu VM
    var total = Model.TotalUsers;
    var lockoutPercent = total == 0 ? 0 : Math.Round((double)Model.LockedUsers * 100 / total, 1);
    var adminPercent   = total == 0 ? 0 : Math.Round((double)Model.AdminUsers   * 100 / total, 1);
}

<h2 class="mb-4">Panel de Administraci√≥n</h2>

<div class="row g-3">
    <div class="col-md-3">
        <div class="card bg-dark text-light border-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">@Model.TotalUsers</div>
                        <small class="text-secondary">Usuarios totales</small>
                    </div>
                    <i class="fas fa-users fa-2x text-secondary"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-light border-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">@Model.AdminUsers</div>
                        <small class="text-secondary">Administradores</small>
                    </div>
                    <i class="fas fa-user-shield fa-2x text-secondary"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-light border-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">@Model.LockedUsers</div>
                        <small class="text-secondary">Bloqueados</small>
                    </div>
                    <i class="fas fa-user-lock fa-2x text-secondary"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <a class="btn btn-primary w-100" asp-area="Admin" asp-controller="Users" asp-action="Index">
            Gestionar Usuarios
        </a>
    </div>
</div>

<!-- üî• NUEVAS M√âTRICAS (derivadas, sin tocar la VM) -->
<div class="row g-3 mt-1">
    <!-- % de bloqueados -->
    <div class="col-md-3">
        <div class="card metric-card border-0 metric-card--orange">
            <div class="card-body text-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">@lockoutPercent%</div>
                        <small class="opacity-75">% de bloqueados</small>
                    </div>
                    <i class="fas fa-user-lock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- % de admins -->
    <div class="col-md-3">
        <div class="card metric-card border-0 metric-card--blue">
            <div class="card-body text-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">@adminPercent%</div>
                        <small class="opacity-75">% de administradores</small>
                    </div>
                    <i class="fas fa-user-shield fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas libres por si luego a√±adimos m√°s KPIs -->
    <div class="col-md-3">
        <div class="card metric-card border-0">
            <div class="card-body text-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h6 mb-0 opacity-75">KPI disponible</div>
                        <small class="opacity-75">A√±ade m√°s m√©tricas aqu√≠</small>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card metric-card border-0 metric-card--purple">
            <div class="card-body text-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h6 mb-0 opacity-75">KPI disponible</div>
                        <small class="opacity-75">Espacio reservado</small>
                    </div>
                    <i class="fas fa-layer-group fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-4 text-secondary" />

<!-- üî• Actividad reciente -->
<div class="card bg-dark border-secondary">
    <div class="card-header bg-transparent border-secondary">
        <h5 class="mb-0 text-light">
            <i class="fas fa-stream text-info me-2"></i> Actividad reciente del sistema
        </h5>
    </div>
    <div class="card-body" id="activity-log">
        <p class="text-muted mb-0">Cargando eventos...</p>
    </div>
</div>

<style>
    /* ====== Estilos m√©tricas (tema oscuro) ====== */
    .metric-card {
        background: linear-gradient(135deg, #1d2630 0%, #111821 100%);
        box-shadow: 0 8px 18px rgba(0,0,0,.35);
        border-radius: .75rem;
    }
    .metric-card--blue {
        background: linear-gradient(135deg, #233a54 0%, #162433 100%);
    }
    .metric-card--orange {
        background: linear-gradient(135deg, #3f2a1a 0%, #2b1c12 100%);
    }
    .metric-card--purple {
        background: linear-gradient(135deg, #2f2143 0%, #21162f 100%);
    }
    .opacity-75 { opacity: .75; }

    /* ====== Estilos actividad reciente ====== */
    #activity-log { color: #e6e6e6; }
    #activity-log .text-muted { color: #b8b8b8 !important; }
    .card-header.bg-transparent h5 { color: #e6e6e6; }
    .border-info {
        --bs-border-opacity: 1;
        border-left: 3px solid rgba(13, 202, 240, var(--bs-border-opacity)) !important;
    }
</style>

@section Scripts {
<script>
(async () => {
    const logContainer = document.getElementById('activity-log');
    try {
        const res = await fetch('@Url.Action("Activity", "Dashboard", new { area = "Admin" })');
        if (!res.ok) throw new Error("No se pudo obtener la actividad.");
        const logs = await res.json();

        logContainer.innerHTML = "";

        if (logs.length === 0) {
            logContainer.innerHTML = `<p class="text-muted mb-0">Sin actividad registrada.</p>`;
            return;
        }

        logs.forEach(l => {
            const icon = l.action.toLowerCase().includes("usuario") ? "üßç"
                       : l.action.toLowerCase().includes("bloqueado") ? "üîí"
                       : l.action.toLowerCase().includes("admin") ? "üëë"
                       : "‚öôÔ∏è";

            const html = `
                <div class="border-start border-info ps-3 mb-3">
                    <div>${icon} <strong>${l.action}</strong></div>
                    <small class="text-muted">
                        ${new Date(l.timestamp).toLocaleString()}
                        ‚Äî ${l.performedBy || "Sistema"}
                        ${l.targetUser ? " ( " + l.targetUser + " )" : ""}
                    </small>
                </div>
            `;
            logContainer.insertAdjacentHTML('beforeend', html);
        });
    } catch (err) {
        logContainer.innerHTML = `<p class="text-danger">${err.message}</p>`;
    }
})();
</script>
}
