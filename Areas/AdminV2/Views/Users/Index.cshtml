@model IEnumerable<Proyecto_Gaming.Areas.AdminV2.ViewModels.UserListViewModel>
@{
    ViewData["Title"] = "Gesti√≥n de Usuarios";
}

<div class="container-fluid">

    <!-- ‚úÖ T√≠tulo + Bot√≥n de acceso a estad√≠sticas -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white m-0">üë• Gesti√≥n de Usuarios</h1>

        <a asp-area="AdminV2" asp-controller="Stats" asp-action="Index"
           class="btn btn-outline-info btn-lg">
            <i class="bi bi-bar-chart-fill me-1"></i> üìä Informes y Estad√≠sticas
        </a>
    </div>

    <!-- üé® NUEVO: Barra de b√∫squeda y filtros -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-light">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" 
                       placeholder="üîç Buscar por nombre o email...">
            </div>
        </div>
        <div class="col-md-4">
            <div class="d-flex gap-2">
                <select class="form-select bg-dark text-light border-secondary" id="roleFilter">
                    <option value="">üë• Todos los roles</option>
                    <option value="Administrador">üõ°Ô∏è Administrador</option>
                    <option value="Usuario">üë§ Usuario</option>
                </select>
                <select class="form-select bg-dark text-light border-secondary" id="statusFilter">
                    <option value="">üìä Todos los estados</option>
                    <option value="true">üü¢ Activos</option>
                    <option value="false">üî¥ Bloqueados</option>
                </select>
            </div>
        </div>
    </div>

    <!-- üé® NUEVO: Tarjetas de resumen -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary bg-opacity-25 border-primary">
                <div class="card-body text-center">
                    <h3 class="text-white">@Model.Count()</h3>
                    <p class="text-light mb-0">üë• Usuarios Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-opacity-25 border-success">
                <div class="card-body text-center">
                    <h3 class="text-white">@Model.Count(u => u.IsActive)</h3>
                    <p class="text-light mb-0">üü¢ Usuarios Activos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger bg-opacity-25 border-danger">
                <div class="card-body text-center">
                    <h3 class="text-white">@Model.Count(u => !u.IsActive)</h3>
                    <p class="text-light mb-0">üî¥ Usuarios Bloqueados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-opacity-25 border-warning">
                <div class="card-body text-center">
                    <h3 class="text-white">@Model.Count(u => u.Role == "Administrador")</h3>
                    <p class="text-light mb-0">üõ°Ô∏è Administradores</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-0 shadow-sm">
        <div class="card-header bg-secondary bg-opacity-25 border-bottom border-secondary">
            <h5 class="text-white mb-0">üìã Lista de Usuarios</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0" id="usersTable">
                    <thead class="table-secondary">
                        <tr>
                            <th class="ps-3">
                                <i class="bi bi-person me-1"></i>Usuario
                            </th>
                            <th>
                                <i class="bi bi-envelope me-1"></i>Email
                            </th>
                            <th>
                                <i class="bi bi-shield me-1"></i>Rol
                            </th>
                            <th>
                                <i class="bi bi-circle-fill me-1"></i>Estado
                            </th>
                            <th style="width:220px;" class="text-center">
                                <i class="bi bi-gear me-1"></i>Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr class="user-row" 
                                data-name="@user.Name?.ToLower()" 
                                data-email="@user.Email?.ToLower()"
                                data-role="@user.Role"
                                data-status="@user.IsActive.ToString().ToLower()">
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-info bg-opacity-25 text-info me-3">
                                            @((user.Name?.FirstOrDefault() ?? 'U').ToString().ToUpper())
                                        </div>
                                        <div>
                                            <div class="fw-bold text-white">@(user.Name ?? "(sin nombre)")</div>
                                            <small class="text-muted">ID: @user.Id.Substring(0, 8)...</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-white">@(user.Email ?? "(sin email)")</div>
                                    <small class="text-muted">@user.Email</small>
                                </td>
                                <td>
                                    <span class="badge @(user.Role == "Administrador" ? "bg-warning" : "bg-info") py-2 px-3">
                                        @if(user.Role == "Administrador") {
                                            <i class="bi bi-shield-check me-1"></i>
                                        } else {
                                            <i class="bi bi-person me-1"></i>
                                        }
                                        @(user.Role ?? "Usuario")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @(user.IsActive ? "bg-success" : "bg-danger") py-2 px-3">
                                        <i class="bi @(user.IsActive ? "bi-check-circle" : "bi-x-circle") me-1"></i>
                                        @(user.IsActive ? "Activo" : "Bloqueado")
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <a asp-action="Details" asp-route-id="@user.Id"
                                           class="btn btn-info btn-sm d-flex align-items-center"
                                           title="Ver perfil completo">
                                            <i class="bi bi-eye me-1"></i> Ver
                                        </a>

                                        <form asp-action="ToggleLock" asp-route-id="@user.Id"
                                              method="post" class="d-inline">
                                            <button type="submit"
                                                    class="btn @(user.IsActive ? "btn-warning" : "btn-success") btn-sm d-flex align-items-center"
                                                    title="@(user.IsActive ? "Bloquear usuario" : "Desbloquear usuario")">
                                                <i class="bi @(user.IsActive ? "bi-lock" : "bi-unlock") me-1"></i>
                                                @(user.IsActive ? "Bloquear" : "Desbl.")
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid;
    }

    .user-row:hover {
        background-color: rgba(255, 255, 255, 0.05) !important;
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }

    .card {
        border: 1px solid #444 !important;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
</style>

@section Scripts {
    <script>
        // üé® NUEVO: Funcionalidad de b√∫squeda y filtros
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');
            const userRows = document.querySelectorAll('.user-row');

            function filterUsers() {
                const searchTerm = searchInput.value.toLowerCase();
                const roleValue = roleFilter.value;
                const statusValue = statusFilter.value;

                userRows.forEach(row => {
                    const name = row.getAttribute('data-name') || '';
                    const email = row.getAttribute('data-email') || '';
                    const role = row.getAttribute('data-role') || '';
                    const status = row.getAttribute('data-status') || '';

                    const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
                    const matchesRole = !roleValue || role === roleValue;
                    const matchesStatus = !statusValue || status === statusValue.toLowerCase();

                    row.style.display = (matchesSearch && matchesRole && matchesStatus) ? '' : 'none';
                });
            }

            searchInput.addEventListener('input', filterUsers);
            roleFilter.addEventListener('change', filterUsers);
            statusFilter.addEventListener('change', filterUsers);
        });
    </script>
}